import{read as f}from"./xlsx-BBMPxr6S.js";const p={jpeg:[{signature:[255,216,255,224]},{signature:[255,216,255,225]},{signature:[255,216,255,226]},{signature:[255,216,255,227]},{signature:[255,216,255,232]},{signature:[255,216,255,219]}],png:[{signature:[137,80,78,71,13,10,26,10]}],gif:[{signature:[71,73,70,56,55,97]},{signature:[71,73,70,56,57,97]}],bmp:[{signature:[66,77]}],webp:[{signature:[82,73,70,70]},{signature:[87,69,66,80],offset:8}],tiff:[{signature:[73,73,42,0]},{signature:[77,77,0,42]}],ico:[{signature:[0,0,1,0]}],mp3:[{signature:[73,68,51]},{signature:[255,251]},{signature:[255,243]},{signature:[255,242]}],mp4:[{signature:[0,0,0,24,102,116,121,112]},{signature:[0,0,0,32,102,116,121,112]}],avi:[{signature:[82,73,70,70]},{signature:[65,86,73,32],offset:8}],mov:[{signature:[0,0,0,20,102,116,121,112,113,116]}],pdf:[{signature:[37,80,68,70]}],zip:[{signature:[80,75,3,4]},{signature:[80,75,5,6]},{signature:[80,75,7,8]}],rar:[{signature:[82,97,114,33,26,7,0]}],sevenZ:[{signature:[55,122,188,175,39,28]}],exe:[{signature:[77,90]}],dll:[{signature:[77,90]}],xlsx:[{signature:[80,75,3,4]}],xls:[{signature:[208,207,17,224,161,177,26,225]}],ods:[{signature:[80,75,3,4]}]},u=[".csv",".xlsx",".xls",".ods"],g={csv:/^[\w\s"',.-]+(?:,[\w\s"',.-]*)*(?:\r?\n|$)/,html:/<\s*html\s*>|<\s*!doctype\s+html/i,xml:/<\?xml\s+version/i,json:/^\s*[\{\[]/,javascript:/^\s*(?:function|var|const|let|import|export)/,css:/^\s*[\w\-\.#\[\]]+\s*\{/};function m(t){const e=new Uint8Array(t.slice(0,512));for(const[s,r]of Object.entries(p))for(const{signature:i,offset:a=0}of r)if(e.length>=a+i.length&&i.every((o,l)=>e[a+l]===o))if(s==="webp"&&a===0){if([87,69,66,80].every((c,d)=>e[8+d]===c))return{type:s,confidence:.95}}else return{type:s,confidence:.9};return{type:"unknown",confidence:0}}function h(t){const e=t.toLowerCase().substring(t.lastIndexOf("."));return u.includes(e)}function v(t){return[/\.(exe|scr|bat|cmd|com|pif|vbs|js|jar|app|deb|dmg|iso|msi)\.(csv|xlsx|xls|txt)$/i,/\.(jpg|jpeg|png|gif|bmp|webp|tiff|ico)\.(csv|xlsx|xls)$/i,/\.(mp3|mp4|avi|mov|wmv|flv|webm)\.(csv|xlsx|xls)$/i].some(s=>s.test(t))}async function x(t){try{const e=await t.arrayBuffer(),s=f(e,{type:"array"});if(!s.SheetNames||s.SheetNames.length===0)return{isValid:!1,error:"No valid sheets found in file"};const r=s.SheetNames[0];return s.Sheets[r]?{isValid:!0}:{isValid:!1,error:"Unable to read sheet content"}}catch(e){return{isValid:!1,error:`Failed to parse as spreadsheet: ${e instanceof Error?e.message:"Unknown error"}`}}}function y(t){try{const e=t.split(/\r?\n/).filter(n=>n.trim());if(e.length===0)return{isValid:!1,error:"File appears to be empty"};if(e.length<2)return{isValid:!1,error:"CSV must have at least a header and one data row"};const s=e[0];if(!g.csv.test(s))return{isValid:!1,error:"File does not appear to be valid CSV format"};const r=s.split(",").length,a=e[1].split(",").length;return Math.abs(r-a)>1?{isValid:!1,error:"Inconsistent column count between header and data rows"}:{isValid:!0}}catch(e){return{isValid:!1,error:`CSV validation failed: ${e instanceof Error?e.message:"Unknown error"}`}}}async function V(t){try{if(!t)return{isValid:!1,error:"No file provided"};if(t.size===0)return{isValid:!1,error:"File is empty"};if(t.size>50*1024*1024)return{isValid:!1,error:"File size exceeds 50MB limit"};const e=t.name;if(v(e))return{isValid:!1,error:"Suspicious filename detected",securityWarning:"Potential double extension attack",filename:e};if(!h(e))return{isValid:!1,error:`Invalid file extension. Allowed: ${u.join(", ")}`,filename:e};const s=await t.arrayBuffer(),{type:r,confidence:i}=m(s);if(["jpeg","png","gif","bmp","webp","tiff","ico","mp3","mp4","avi","mov","exe","dll","pdf"].includes(r))return{isValid:!1,error:`File appears to be ${r.toUpperCase()}, not a spreadsheet`,detectedType:r,securityWarning:`Potential security threat: ${r.toUpperCase()} file disguised as spreadsheet`,filename:e,confidence:i};if(e.toLowerCase().endsWith(".csv")){const n=await t.text(),o=y(n);if(!o.isValid)return{isValid:!1,error:o.error,filename:e,detectedType:"text",fileType:"csv"}}else{const n=await x(t);if(!n.isValid)return{isValid:!1,error:n.error,filename:e,detectedType:r,confidence:i}}return{isValid:!0,filename:e,detectedType:r==="unknown"?"spreadsheet":r,confidence:i||.8,fileType:e.toLowerCase().endsWith(".csv")?"csv":"spreadsheet"}}catch(e){return{isValid:!1,error:`Validation failed: ${e instanceof Error?e.message:"Unknown error"}`,filename:t?.name}}}export{V as validateFile};
